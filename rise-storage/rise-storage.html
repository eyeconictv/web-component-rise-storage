<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/components/core-ajax/core-ajax.html">

<!--
The `rise-storage` element retrieves URLs of files stored in Rise Storage.

    <rise-storage
      companyId="my-company-id"
      folder="my-folder"
      fileName="my-image.png"
      folderRefresh="60"></rise-storage>

You can trigger a request explicitly by calling `go` on the
element.

@element rise-storage
@status alpha
@homepage https://github.com/Rise-Vision/web-component-rise-storage
-->
<polymer-element name="rise-storage" attributes="companyId folder fileName folderRefresh">
  <template>
    <core-ajax id="ajax"
      url="{{url}}"
      handleAs="json"
      on-core-response="{{handleResponse}}"
      on-core-error="{{handleError}}"
      auto>
    </core-ajax>
  </template>

  <script>
    Polymer("rise-storage", {
      /**
       * Fired when a response is received.
       *
       * @event rise-storage-response
       */

      /**
       * Fired when an error is received.
       *
       * @event rise-storage-error
       */

      /**
       * The ID of the Company.
       *
       * @attribute companyId
       * @type string
       * @default ""
       */
      companyId: "",

      /**
       * The folder name.
       *
       * @attribute folder
       * @type string
       * @default ""
       */
      folder: "",

      /**
       * The file name within the folder.
       *
       * @attribute fileName
       * @type string
       * @default ""
       */
      fileName: "",

      /**
       * The number of seconds before the folder will be checked for changes.

       *
       * @attribute folderRefresh
       * @type number
       * @default 0
       */
      folderRefresh: 0,

      /**
       * The URL target of the request.
       *
       * @property url
       * @type string
       * @default ''
       */
      url: "",

      ready: function() {
        this.setUrl();
      },

      setUrl: function() {
        var url = "";

        if (this.companyId) {
          url = "https://www.googleapis.com/storage/v1/b/risemedialibrary-" + encodeURIComponent(this.companyId) + "/o";

          if (this.folder) {
            // Get a specific file in a specific folder.
            if (this.fileName) {
              url += "?delimiter=/&prefix=" + encodeURIComponent(this.folder) + "/" + encodeURIComponent(this.fileName);
            }
            else {
              // Get all files in a specific folder.
              url += "?delimiter=/&prefix=" + encodeURIComponent(this.folder) + "/";
            }
          }
          // Get a specific file in the root folder.
          else if (this.fileName) {
            url += "/" + encodeURIComponent(this.fileName);
          }

          this.url = url;
        }

        // TODO: Implement folderRefresh.
      },

      companyIdChanged: function() {
        this.setUrl();
      },

      folderChanged: function() {
        this.setUrl();
      },

      fileNameChanged: function() {
        this.setUrl();
      },

      handleResponse: function(e, resp) {
        var urls = [];

        // Send back array of URLs.
        if (resp && resp.response && resp.response.items) {
          resp.response.items.forEach(function(elem, index) {
            // Check that this is not the folder itself.
            if (elem.contentType && elem.contentType !== "text/plain") {
              if (elem.mediaLink) {
                urls.push(elem.mediaLink);
              }
            }
          });
        }
        else if (resp && resp.response && resp.response.mediaLink) {
          urls.push(resp.response.mediaLink);
        }

        this.fire("rise-storage-response", urls);
      },

      handleError: function(e, resp){
        console.log("Error: " + resp.xhr.status + " " + resp.xhr.statusText);

        this.fire("rise-storage-error", resp);
      },

      /**
       * Performs an Ajax request to the specified URL.
       *
       * @method go
       */
      go: function() {
        this.$.ajax.go();
      }
    });
  </script>
</polymer-element>

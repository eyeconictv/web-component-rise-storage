<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../rise-storage.html">
</head>
<body>
  <rise-storage id="cache-file" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="cache-file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>

  <script src="../js/rise-storage-data.js"></script>
  <script>
    suite("rise-storage", function() {
      var clock,
        server,
        responseHandler,
        cacheFile = document.querySelector("#cache-file"),
        cacheFileFolder = document.querySelector("#cache-file-folder"),
        cacheHeader = { "Last-Modified": "Fri, 01 May 2015 15:32:11 GMT" },
        newCacheHeader = { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" };

      // Runs for every suite.
      suiteSetup(function() {
        server = sinon.fakeServer.create();

        // Send a response to the ping request.
        server.respondWith("GET", "http://localhost:9494/ping?callback=_handlePingResponse",
          [200, cacheHeader, ""]);

        clock = sinon.useFakeTimers();
      });

      suiteTeardown(function() {
        server.restore()
        clock.restore();
      });

      suite("Rise Cache - bucket file", function() {
        setup(function() {
          cacheFile._reset();
          cacheFile._isCacheRunning = true;
          cacheFile._pingReceived = true;
          cacheFile._fileUrl = "https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg";
        });

        test("should return the correct URL for a specific file in a bucket", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.name, "home.jpg");
            assert.equal(response.detail.url, "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");

            cacheFile.removeEventListener("rise-storage-response", responseHandler);

            done();
          };

          cacheFile.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, cacheHeader, ""]);
          cacheFile._getFileFromCache();
          server.respond();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          responseHandler = sinon.spy();

          cacheFile.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, cacheHeader, ""]);
          cacheFile._getFileFromCache();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.name, "home.jpg");
            assert.equal(response.detail.url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");

            cacheFile.removeEventListener("rise-storage-response", responseHandler);

            done();
          };

          cacheFile._files.push({
            "name": "home.jpg", "lastModified": ""
          });

          cacheFile._isLoading = false;
          cacheFile.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, newCacheHeader, ""]);
          cacheFile._getFileFromCache();
          server.respond();
        });
      });

      suite("Rise Cache - folder file", function() {
        setup(function() {
          cacheFileFolder._reset();
          cacheFileFolder._isCacheRunning = true;
          cacheFileFolder._pingReceived = true;
          cacheFileFolder._fileUrl = "https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
        });

        test("should return the correct URL for a specific file in a folder", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.name, "images/home.jpg");
            assert.equal(response.detail.url, "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");

            cacheFileFolder.removeEventListener("rise-storage-response", responseHandler);

            done();
          };

          server.respondWith([200, cacheHeader, ""]);
          cacheFileFolder.addEventListener("rise-storage-response", responseHandler);
          cacheFileFolder._getFileFromCache();
          server.respond();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          responseHandler = sinon.spy();

          cacheFileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, cacheHeader, ""]);
          cacheFileFolder._getFileFromCache();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.name, "images/home.jpg");
            assert.equal(response.detail.url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");

            cacheFileFolder.removeEventListener("rise-storage-response", responseHandler);

            done();
          };

          cacheFileFolder._files.push({
            "name": "risemedialibrary-abc123/images/home.jpg", "lastModified": ""
          });

          cacheFileFolder._isLoading = false;
          cacheFileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, newCacheHeader, ""]);
          cacheFileFolder._getFileFromCache();
          server.respond();
        });
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../rise-storage.html">
</head>
<body>
  <rise-storage id="folder" companyId="abc123" folder="images"></rise-storage>
  <rise-storage id="file" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>
  <rise-storage id="file-type" companyId="abc123" folder="my-folder" fileType="image"></rise-storage>
  <rise-storage id="content-type" companyId="abc123" folder="my-folder" contentType="image/jpeg image/bmp"></rise-storage>
  <rise-storage id="cache-file" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="cache-file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>
  <rise-storage id="offline-player" companyId="abc123" folder="images"></rise-storage>

  <script src="../js/rise-storage-data.js"></script>
  <script>
    suite("rise-storage", function() {
      var clock,
        server,
        responseHandler,
        folder = document.querySelector("#folder"),
        file = document.querySelector("#file"),
        fileFolder = document.querySelector("#file-folder"),
        fileType = document.querySelector("#file-type"),
        contentType = document.querySelector("#content-type"),
        cacheFile = document.querySelector("#cache-file"),
        cacheFileFolder = document.querySelector("#cache-file-folder"),
        offlinePlayer = document.querySelector("#offline-player"),
        cacheHeader = { "Last-Modified": "Fri, 01 May 2015 15:32:11 GMT" },
        newCacheHeader = { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" };

      // Runs for every suite.
      suiteSetup(function() {
        server = sinon.fakeServer.create();

        // Send a response to the ping request.
        server.respondWith("GET", "http://localhost:9494/ping?callback=_handlePingResponse",
          [200, cacheHeader, ""]);

        clock = sinon.useFakeTimers();
      });

      suiteTeardown(function() {
        server.restore()
        clock.restore();
      });

      suite("file in a bucket", function() {
        setup(function() {
          file._isCacheRunning = false;
          file._pingReceived = true;
        });

        teardown(function() {
          bucketImage.etag = "COjLvarr/cQCEAE=";
          file.removeEventListener("rise-storage-response", responseHandler);
        });

        test("should return the correct URL for a specific file in a bucket", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg?alt=media");
            done();
          };

          file.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(bucketImage)]);
          file.go();
          server.respond();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          responseHandler = sinon.spy();

          file.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(bucketImage)]);
          file.go();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg?alt=media&cb=0");
            done();
          };

          var localBucketImage = JSON.parse(JSON.stringify(bucketImage));
          localBucketImage.etag = "new";

          file.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(localBucketImage)]);
          file.go();
          server.respond();
        });
      });

      suite("file in a folder", function() {
        var localFolderImage;

        setup(function() {
          fileFolder._reset();
          fileFolder._isCacheRunning = false;
          fileFolder._pingReceived = true;
          localFolderImage = JSON.parse(JSON.stringify(folderImage));
        });

        teardown(function() {
          folderImage = localFolderImage;
          fileFolder.removeEventListener("rise-storage-response", responseHandler);
        });

        test("should return the correct URL for a specific file in a folder", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            done();
          };

          fileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(folderImage)]);
          fileFolder.go();
          server.respond();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          responseHandler = sinon.spy();

          fileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(folderImage)]);
          fileFolder.go();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 2) {
              assert.equal(files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
              assert.equal(files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media&cb=0");
              assert.isTrue(files[0].added);
              assert.isTrue(files[1].changed);
              done();
            }
          };

          fileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(folderImage)]);
          fileFolder.go();
          server.respond();

          folderImage.items[0].etag = "new";

          server.respondWith([200, header, JSON.stringify(folderImage)]);
          fileFolder.go();
          server.respond();
        });
      });

      suite("folder", function() {
        var localImages;

        setup(function() {
          folder._reset();
          folder._isCacheRunning = false;
          folder._pingReceived = true;
          localImages = JSON.parse(JSON.stringify(images));
        });

        teardown(function() {
          images = localImages;
          folder.removeEventListener("rise-storage-response", responseHandler);
        });

        test("should return the correct URLs for files in a folder", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 3) {
              assert.equal(files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
              assert.equal(files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media");
              assert.equal(files[2].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
              done();
            }
          };

          folder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(images)]);
          folder.go();
          server.respond();
        });

        test("should not send notifications if none of the files have changed", function(done) {
          responseHandler = sinon.spy();

          folder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(images)]);
          folder.go();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if a file has changed", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 4) {
              assert.equal(files[3].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media&cb=0");
              assert.isTrue(files[3].changed);
              done();
            }
          };

          server.respondWith([200, header, JSON.stringify(images)]);
          folder.addEventListener("rise-storage-response", responseHandler);
          folder.go();
          server.respond();

          images.items[2].etag = "new";

          server.respondWith([200, header, JSON.stringify(images)]);
          folder.go();
          server.respond();
        });

        test("should return URL of a file that has been added to a folder", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 4) {
              assert.equal(files[3].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fgolf.svg?alt=media&cb=0");
              done();
            }
          };

          server.respondWith([200, header, JSON.stringify(images)]);
          folder.addEventListener("rise-storage-response", responseHandler);
          folder.go();
          server.respond();

          images.items.push({
            "name": "images/golf.svg",
            "contentType": "image/svg+xml",
            "updated": "2015-01-30T08:19:09.263Z",
            "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fgolf.svg",
            "etag": "CPjC1qHc7MQCEAE="
          });

          server.respondWith([200, header, JSON.stringify(images)]);
          folder.go();
          server.respond();
        });

        test("should not return URL of a file that has been removed from a folder", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 4) {
              assert.equal(files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
              assert.equal(files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media");
              assert.equal(files[2].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
              assert.equal(files[3].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
              assert.isTrue(files[3].deleted);
              done();
            }
            else if(files.length > 4) {
              assert.isTrue(false);
            }
          };

          server.respondWith([200, header, JSON.stringify(images)]);
          folder.addEventListener("rise-storage-response", responseHandler);
          folder.go();
          server.respond();

          images.items.pop();

          server.respondWith([200, header, JSON.stringify(images)]);
          folder.go();
          server.respond();
        });
      });

      suite("filtering", function() {
        setup(function() {
          fileType._reset();
          fileType._isCacheRunning = false;
          fileType._pingReceived = true;
          contentType._reset();
          contentType._isCacheRunning = false;
          contentType._pingReceived = true;
        });

        teardown(function() {
          fileType.removeEventListener("rise-storage-response", responseHandler);
          contentType.removeEventListener("rise-storage-response", responseHandler);
        });

        test("should return only images when filtering by fileType", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 5) {
              done();
            }
          };

          fileType.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(mixedMedia)]);
          fileType.go();
          server.respond();
        });

        test("should return only image/jpeg and image/bmp files when filtering by contentType", function(done) {
          var files = [];

          responseHandler = function(response) {
            files.push(response.detail);

            if(files.length === 2) {
              assert.equal(files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
              assert.equal(files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
              done();
            }
          };

          contentType.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, header, JSON.stringify(mixedMedia)]);
          contentType.go();
          server.respond();
        });
      });

      suite("Rise Cache - bucket file", function() {
        setup(function() {
          cacheFile._reset();
          cacheFile._isCacheRunning = true;
          cacheFile._pingReceived = true;
          cacheFile._fileUrl = "https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg";
        });

        teardown(function() {
          cacheFile.removeEventListener("rise-storage-response", responseHandler);
        });

        test("should return the correct URL for a specific file in a bucket", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");
            done();
          };

          cacheFile.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, cacheHeader, ""]);
          cacheFile._getFileFromCache();
          server.respond();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          responseHandler = sinon.spy();

          cacheFile.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, cacheHeader, ""]);
          cacheFile._getFileFromCache();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");
            done();
          };

          cacheFile._items.push({
            "name": "home.jpg", "lastModified": ""
          });

          cacheFile._isLoading = false;
          cacheFile.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, newCacheHeader, ""]);
          cacheFile._getFileFromCache();
          server.respond();
        });
      });

      suite("Rise Cache - folder file", function() {
        setup(function() {
          cacheFileFolder._reset();
          cacheFileFolder._isCacheRunning = true;
          cacheFileFolder._pingReceived = true;
          cacheFileFolder._fileUrl = "https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
        });

        teardown(function() {
          cacheFileFolder.removeEventListener("rise-storage-response", responseHandler);
        });

        test("should return the correct URL for a specific file in a folder", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
            done();
          };

          server.respondWith([200, cacheHeader, ""]);
          cacheFileFolder.addEventListener("rise-storage-response", responseHandler);
          cacheFileFolder._getFileFromCache();
          server.respond();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          responseHandler = sinon.spy();

          cacheFileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, cacheHeader, ""]);
          cacheFileFolder._getFileFromCache();
          server.respond();

          assert(responseHandler.notCalled);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          responseHandler = function(response) {
            assert.equal(response.detail.url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
            done();
          };

          cacheFileFolder._items.push({
            "name": "risemedialibrary-abc123/images/home.jpg", "lastModified": ""
          });

          cacheFileFolder._isLoading = false;
          cacheFileFolder.addEventListener("rise-storage-response", responseHandler);
          server.respondWith([200, newCacheHeader, ""]);
          cacheFileFolder._getFileFromCache();
          server.respond();
        });
      });

      suite("offline-player integration", function() {
        var sandbox;

        setup(function() {
          offlinePlayer._reset();
          offlinePlayer.offlinePlayer = window;
          offlinePlayer.offlinePlayerOrigin = "*";
          offlinePlayer.pingReceived = true;
          offlinePlayer.isCacheRunning = false;

          clock.restore();
          sandbox = sinon.sandbox.create();
        });

        teardown(function() {
          clock = sinon.useFakeTimers();
          sandbox.restore();
        });

        test("should be running inside offline-player", function(done) {
          offlinePlayer.offlinePlayer = null;
          offlinePlayer.offlinePlayerOrigin = null;
          offlinePlayer.pingReceived = false;
          offlinePlayer.isCacheRunning = false;

          window.postMessage("register.chrome.app.window", "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._isOfflinePlayer());
            done();
          }, 0);
        });

        test("should reload data when target matches offline-player event targets", function(done) {
          sandbox.spy(offlinePlayer, "_loadStorage");

          window.postMessage({ type: "storage-target-changed", targets: ["risemedialibrary-abc123/images/"] }, "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._loadStorage.called);
            done();
          }, 0);
        });

        test("should not reload data when targets do not match offline-player event targets", function(done) {
          sandbox.spy(offlinePlayer, "_loadStorage");

          window.postMessage({ type: "storage-target-changed", targets: ["risemedialibrary-abc123/videos/"] }, "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._loadStorage.notCalled);
            done();
          }, 0);
        });

        test("should ignore data load events not directed to this instance", function(done) {
          sandbox.spy(offlinePlayer, "_handleStorageResponse");

          window.postMessage({ type: "storage-component-loaded", clientId: -1 }, "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._handleStorageResponse.notCalled);
            done();
          }, 0);
        });

        test("should process data load events directed to this instance", function(done) {
          sandbox.spy(offlinePlayer, "_handleStorageResponse");

          window.postMessage({ type: "storage-component-loaded", clientId: offlinePlayer.offlinePlayerClientId }, "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._handleStorageResponse.called);
            done();
          }, 0);
        });

        test("should ignore response updated events not directed to this instance", function(done) {
          sandbox.spy(offlinePlayer, "_processStorageResponse");

          window.postMessage({ type: "storage-component-response-updated", clientId: -1 }, "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._processStorageResponse.notCalled);
            done();
          }, 0);
        });

        test("should process response updated events directed to this instance", function(done) {
          sandbox.spy(offlinePlayer, "_processStorageResponse");

          window.postMessage({ type: "storage-component-response-updated", clientId: offlinePlayer.offlinePlayerClientId }, "*");

          setTimeout(function() {
            assert.isTrue(offlinePlayer._processStorageResponse.called);
            done();
          }, 0);
        });

        test("should send a rise-storage-response event after receiving a response updated notification", function(done) {
          var storageResponse = {
            files: [{
              name: "images/image.jpg",
              selfLink: "https://storage.googleapis.com/risemedialibrary-abc123/images%2Fimage.jpg",
              etag: "test-etag"
            }]
          };

          responseHandler = function(response) {
            assert.equal(response.detail.url, "https://storage.googleapis.com/risemedialibrary-abc123/images%2Fimage.jpg?alt=media");
            assert.isTrue(response.detail.url.startsWith("https://storage.googleapis.com/risemedialibrary-abc123/images%2Fimage.jpg?alt=media"));
            done();
          };

          offlinePlayer.addEventListener("rise-storage-response", responseHandler);
          window.postMessage({ type: "storage-component-response-updated",
                               clientId: offlinePlayer.offlinePlayerClientId,
                               response: storageResponse
                             }, "*");
        });
      });
    });
  </script>
</body>
</html>

<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="/components/webcomponentsjs/webcomponents.js"></script>
  <script src="/components/web-component-tester/browser.js"></script>

  <link rel="import" href="/rise-storage.html">
</head>
<body>

  <rise-storage id="invalid"></rise-storage>
  <rise-storage id="bucket" companyId="abc123"></rise-storage>
  <rise-storage id="folder" companyId="abc123" folder="my-folder" refresh="10"></rise-storage>
  <rise-storage id="file" companyId="abc123" fileName="circle.png" refresh="10"></rise-storage>
  <rise-storage id="file-folder" companyId="abc123" folder="my-folder" fileName="circle.png"></rise-storage>
  <rise-storage id="file-type" companyId="abc123" folder="my-folder" fileType="image"></rise-storage>
  <rise-storage id="content-type" companyId="abc123" folder="my-folder" contentType="image/jpeg image/png"></rise-storage>
  <rise-storage id="sorting" companyId="abc123" folder="my-folder" fileType="video" sort="name" sortDirection="asc"></rise-storage>

  <script>
    suite("rise-storage", function() {
      var invalid = document.querySelector("#invalid"),
        bucket = document.querySelector("#bucket"),
        folder = document.querySelector("#folder"),
        file = document.querySelector("#file"),
        fileFolder = document.querySelector("#file-folder"),
        fileType = document.querySelector("#file-type"),
        contentType = document.querySelector("#content-type"),
        sorting = document.querySelector("#sorting"),
        headers = {
          "Content-Type": "text/json"
        },
        bucketFile = JSON.stringify({
          "name": "home.jpg",
          "contentType": "image/jpeg",
          "updated": "2015-02-04T17:45:25.945Z",
          "mediaLink": "https://url.to.home.jpg"
        }),
        bucketFiles = JSON.stringify({
          "items": [{
            "name": "home.jpg",
            "contentType": "image/jpeg",
            "updated": "2015-02-04T17:45:25.945Z",
            "mediaLink": "https://url.to.home.jpg"
          },
          {
            "name": "turtle.gif",
            "contentType": "image/gif",
            "updated": "2015-02-04T17:46:31.263Z",
            "mediaLink": "https://url.to.turtle.gif"
          }]
        }),
        folderFile = JSON.stringify({
          "items": [{
            "name": "my-folder/home.jpg",
            "contentType": "image/jpeg",
            "updated": "2015-02-04T17:45:25.945Z",
            "mediaLink": "https://url.to.home.jpg"
          }]
        }),
        folderFiles = JSON.stringify({
          "items": [{
            "name": "my-folder/",
            "contentType": "text/plain",
            "updated": "2015-02-04T17:44:00.549Z",
            "mediaLink": "https://url.to.my-folder"
          },
          {
            "name": "my-folder/home.jpg",
            "contentType": "image/jpeg",
            "updated": "2015-02-04T17:45:25.945Z",
            "mediaLink": "https://url.to.home.jpg"
          },
          {
            "name": "my-folder/circle.png",
            "contentType": "image/png",
            "updated": "2015-02-06T14:25:11.312Z",
            "mediaLink": "https://url.to.circle.png"
          },
          {
            "name": "my-folder/my-image.bmp",
            "contentType": "image/bmp",
            "updated": "2015-02-06T11:24:13.313Z",
            "mediaLink": "https://url.to.my-image.bmp"
          },
          {
            "name": "my-folder/golf.svg",
            "contentType": "image/svg+xml",
            "updated": "2015-01-30T08:19:09.263Z",
            "mediaLink": "https://url.to.golf.svg"
          },
          {
            "name": "my-folder/turtle.gif",
            "contentType": "image/gif",
            "updated": "2015-02-04T17:46:31.263Z",
            "mediaLink": "https://url.to.turtle.gif"
          },
          {
            "name": "my-folder/car-ad.mp4",
            "contentType": "video/mp4",
            "updated": "2015-02-02T10:03:11.263Z",
            "mediaLink": "https://url.to.car-ad.mp4"
          },
          {
            "name": "my-folder/walking-dead.ogv",
            "contentType": "video/ogg",
            "updated": "2015-02-01T09:08:15.263Z",
            "mediaLink": "https://url.to.walking-dead.ogv"
          },
          {
            "name": "my-folder/south-park.webm",
            "contentType": "video/webm",
            "updated": "2015-02-03T19:13:45.263Z",
            "mediaLink": "https://url.to.south-park.webm"
          },
          ]
        }),
        xhr, requests, listener;

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };
      });

      suiteTeardown(function() {
        xhr.restore();
      });

      setup(function() {
        requests = [];
      });

      suite("initialization", function() {
        test("defaults are correct", function() {
          assert.equal(invalid.companyId, "");
          assert.equal(invalid.folder, "");
          assert.equal(invalid.fileName, "");
          assert.equal(invalid.refresh, 0);
        });

        test("Storage URLs have the expected values", function() {
          assert.equal(invalid.url, "");
          assert.equal(bucket.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o?delimiter=%2F");
          assert.equal(folder.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o?delimiter=%2F&prefix=my-folder/");
          assert.equal(file.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/circle.png");
          assert.equal(fileFolder.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o?delimiter=%2F&prefix=my-folder/circle.png");
        });
      });

      suite("Rise Storage", function() {
        test("should not make a request when there's no companyId", function(done) {
          listener = function(response) {};

          invalid.addEventListener("rise-storage-response", listener);
          invalid.go();
          invalid.removeEventListener("rise-storage-response", listener);
          assert.equal(requests.length, 0);
          done();
        });

        test("should get files in a bucket", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 2);
            bucket.removeEventListener("rise-storage-response", listener);
          };

          bucket.addEventListener("rise-storage-response", listener);
          bucket.go();
          requests[0].respond(200, headers, bucketFiles);
          done();
        });

        test("should get files in a folder", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 8);
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should get a specific file in a bucket", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 1);
            file.removeEventListener("rise-storage-response", listener);
          };

          file.addEventListener("rise-storage-response", listener);
          file.go();
          requests[0].respond(200, headers, bucketFile);
          done();
        });

        test("should get a specific file in a folder", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 1);
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, headers, folderFile);
          done();
        });

        test("should use correct URL after attribute change", function(done) {
          folder.setAttribute("fileName", "circle.png");
          folder.go();
          assert.equal(folder.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o?delimiter=%2F&prefix=my-folder/circle.png");
          folder.removeAttribute("fileName");
          done();
        });

        test("should return Rise Cache URLs for multiple files in a folder", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 8);
            assert.equal(response.detail[0], "http://localhost:9494/?url=https%3A//url.to.home.jpg");
            assert.equal(response.detail[1], "http://localhost:9494/?url=https%3A//url.to.circle.png");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.isCacheRunning = true;

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should return Rise Cache URLs for a specific file in a bucket", function(done) {
          listener = function(response) {
           assert.equal(response.detail.length, 1);
            assert.equal(response.detail[0], "http://localhost:9494/?url=https%3A//url.to.home.jpg");
            file.removeEventListener("rise-storage-response", listener);
          };

          file.isCacheRunning = true;

          file.addEventListener("rise-storage-response", listener);
          file.go();
          requests[0].respond(200, headers, bucketFile);
          done();
        });

        suite("rise-storage-response", function() {
          var responded;

          setup(function() {
            responded = false;
          });

          test("should fire rise-storage-response on success", function(done) {
            listener = function(response) {
              responded = true;
              bucket.removeEventListener("rise-storage-response", listener);
            };

            bucket.addEventListener("rise-storage-response", listener);
            bucket.go();
            requests[0].respond(200, headers, bucketFile);
            assert.isTrue(responded);
            done();
          });

          test("should not fire rise-storage-response on failure", function(done) {
            listener = function(response) {
              responded = true;
              bucket.removeEventListener("rise-storage-response", listener);
            };

            bucket.addEventListener("rise-storage-response", listener);
            bucket.go();
            requests[0].respond(404, headers, bucketFile);
            assert.isFalse(responded);
            done();
          });
        });

        suite("rise-storage-error", function() {
          var responded;

          setup(function() {
            responded = false;
          });

          test("should fire rise-storage-error on failure", function(done) {
            listener = function(response) {
              responded = true;
              bucket.removeEventListener("rise-storage-error", listener);
            };

            bucket.addEventListener("rise-storage-error", listener);
            bucket.go();
            requests[0].respond(404, headers, bucketFile);
            assert.isTrue(responded);
            done();
          });

          test("should not fire rise-storage-error on success", function(done) {
            listener = function(response) {
              responded = true;
              bucket.removeEventListener("rise-storage-error", listener);
            };

            bucket.addEventListener("rise-storage-error", listener);
            bucket.go();
            requests[0].respond(200, headers, bucketFile);
            assert.isFalse(responded);
            done();
          });
        });
      });

      suite("Rise Cache", function() {
        var headers = {
          "Content-Type": "text/plain"
        };

        test("should make a ping request with Rise Cache running", function(done) {
          bucket.$.ping.go();
          requests[0].respond(200, headers, "handlePingResponse();");

          // Ping request + storage request
          assert.equal(requests.length, 2);
          assert.isTrue(bucket.isCacheRunning);
          done();
        });

        test("should make a ping request with Rise Cache not running", function(done) {
          bucket.$.ping.go();
          requests[0].respond(200, headers, "");

          // Ping request + storage request
          assert.equal(requests.length, 2);
          assert.isFalse(bucket.isCacheRunning);
          done();
        });

        test("should error out on a ping request", function(done) {
          bucket.$.ping.go();
          requests[0].respond(404, headers, "handlePingResponse();");

          // Ping request + storage request
          assert.equal(requests.length, 2);
          assert.isFalse(bucket.isCacheRunning);
          done();
        });
      });

      suite("filtering", function() {
        test("should return only image files when filtering by fileType", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 5);
            fileType.removeEventListener("rise-storage-response", listener);
          };

          fileType.addEventListener("rise-storage-response", listener);
          fileType.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should return only video files when filtering by fileType", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 3);
            fileType.removeEventListener("rise-storage-response", listener);
          };

          fileType.setAttribute("fileType", "video");
          fileType.addEventListener("rise-storage-response", listener);
          fileType.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should return only .jpg and .png files when filtering by contentType", function(done) {
          listener = function(response) {
            assert.equal(response.detail.length, 2);
            assert.equal(response.detail[0], "https://url.to.home.jpg");
            assert.equal(response.detail[1], "https://url.to.circle.png");
            contentType.removeEventListener("rise-storage-response", listener);
          };

          contentType.addEventListener("rise-storage-response", listener);
          contentType.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });
      });

      suite("sorting", function() {
        test("should sort in ascending order by name", function(done) {
          listener = function(response) {
            assert.equal(response.detail[0], "https://url.to.car-ad.mp4");
            assert.equal(response.detail[1], "https://url.to.south-park.webm");
            assert.equal(response.detail[2], "https://url.to.walking-dead.ogv");
            sorting.removeEventListener("rise-storage-response", listener);
          };

          sorting.addEventListener("rise-storage-response", listener);
          sorting.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should sort in descending order by name", function(done) {
          listener = function(response) {
            assert.equal(response.detail[0], "https://url.to.walking-dead.ogv");
            assert.equal(response.detail[1], "https://url.to.south-park.webm");
            assert.equal(response.detail[2], "https://url.to.car-ad.mp4");
            sorting.removeEventListener("rise-storage-response", listener);
          };

          sorting.setAttribute("sortDirection", "desc");
          sorting.addEventListener("rise-storage-response", listener);
          sorting.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should sort in ascending order by date", function(done) {
          listener = function(response) {
            assert.equal(response.detail[0], "https://url.to.walking-dead.ogv");
            assert.equal(response.detail[1], "https://url.to.car-ad.mp4");
            assert.equal(response.detail[2], "https://url.to.south-park.webm");
            sorting.removeEventListener("rise-storage-response", listener);
          };

          sorting.setAttribute("sort", "date");
          sorting.setAttribute("sortDirection", "asc");
          sorting.addEventListener("rise-storage-response", listener);
          sorting.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should sort in descending order by date", function(done) {
          listener = function(response) {
            assert.equal(response.detail[0], "https://url.to.south-park.webm");
            assert.equal(response.detail[1], "https://url.to.car-ad.mp4");
            assert.equal(response.detail[2], "https://url.to.walking-dead.ogv");
            sorting.removeEventListener("rise-storage-response", listener);
          };

          sorting.setAttribute("sortDirection", "desc");
          sorting.addEventListener("rise-storage-response", listener);
          sorting.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should sort in random order", function(done) {
          listener = function(response) {
            /* Not possible to predict what order files will be returned in,
            only that they are returned. */
            assert.equal(response.detail.length, 3);
            sorting.removeEventListener("rise-storage-response", listener);
          };

          sorting.setAttribute("sort", "random");
          sorting.addEventListener("rise-storage-response", listener);
          sorting.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });

        test("should sort in ascending order when no sortDirection is specified", function(done) {
          listener = function(response) {
            assert.equal(response.detail[0], "https://url.to.walking-dead.ogv");
            assert.equal(response.detail[1], "https://url.to.car-ad.mp4");
            assert.equal(response.detail[2], "https://url.to.south-park.webm");
            sorting.removeEventListener("rise-storage-response", listener);
          };

          sorting.setAttribute("sort", "date");
          sorting.removeAttribute("sortDirection");
          sorting.addEventListener("rise-storage-response", listener);
          sorting.go();
          requests[0].respond(200, headers, folderFiles);
          done();
        });
      });

      suite("refresh", function() {
        var clock, pingSpy, timerSpy;

        suiteSetup(function() {
          clock = sinon.useFakeTimers();
        });

        suiteTeardown(function() {
          clock.restore();
        });

        test("should check for changes to a folder & enforce minimum refresh time", function() {
          pingSpy = sinon.spy(folder.$.ping, "go");
          timerSpy = sinon.spy(folder, "startTimer");

          folder.startTimer();

          // startTimer should not fire after 10 minutes have elapsed (refresh=10).
          clock.tick(600000);
          assert(pingSpy.notCalled);

          // Advance clock 5 minutes - startTimer should fire.
          clock.tick(300000);
          assert(pingSpy.calledOnce);
          assert(timerSpy.calledTwice);
        });

        test("should not check for changes to a file", function() {
          pingSpy = sinon.spy(file.$.ping, "go");
          timerSpy = sinon.spy(file, "startTimer");

          file.startTimer(pingSpy);
          clock.tick(10000);
          assert(pingSpy.notCalled);
          assert(timerSpy.calledOnce);
        });
      });
    });
  </script>
</body>
</html>

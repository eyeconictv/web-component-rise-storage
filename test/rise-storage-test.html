<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="/components/webcomponentsjs/webcomponents.js"></script>
  <script src="/components/web-component-tester/browser.js"></script>

  <link rel="import" href="/rise-storage/rise-storage.html">
</head>
<body>

  <rise-storage id="storage1"></rise-storage>
  <rise-storage id="storage2" companyId="abc123"></rise-storage>
  <rise-storage id="storage3" companyId="abc123" folder="my-folder" folderRefresh="10"></rise-storage>
  <rise-storage id="storage4" companyId="abc123" fileName="my-image.png" folderRefresh="10"></rise-storage>
  <rise-storage id="storage5" companyId="abc123" folder="my-folder" fileName="my-image.png"></rise-storage>

  <script>
    suite("rise-storage", function() {
      var storage = document.querySelector("#storage1"),
        storage2 = document.querySelector("#storage2"),
        storage3 = document.querySelector("#storage3"),
        storage4 = document.querySelector("#storage4"),
        storage5 = document.querySelector("#storage5"),
        xhr, requests;

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };
      });

      suiteTeardown(function() {
        xhr.restore();
      });

      setup(function() {
        requests = [];
      });

      suite("initialization", function() {
        test("defaults are correct", function() {
          assert.equal(storage.companyId, "");
          assert.equal(storage.folder, "");
          assert.equal(storage.fileName, "");
          assert.equal(storage.folderRefresh, 0);
        });

        test("Storage URLs have the expected values", function() {
          assert.equal(storage.url, "");
          assert.equal(storage2.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o");
          assert.equal(storage3.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o?delimiter=/&prefix=my-folder/");
          assert.equal(storage4.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/my-image.png");
          assert.equal(storage5.url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o?delimiter=/&prefix=my-folder/my-image.png");
        });
      });

      suite("Storage requests", function() {
        var headers = {
            "Content-Type": "text/json"
          },
          bucketFile = JSON.stringify({
            "contentType": "image/jpeg",
            "mediaLink": "https://url.to.my-image.jpg"
          }),
          multipleFiles = JSON.stringify({
            "items": [{
              "contentType": "image/jpeg",
              "mediaLink": "https://url.to.my-image.jpg"
            },
            {
              "contentType": "image/gif",
              "mediaLink": "https://url.to.my-image.gif"
            },
            {
              "contentType": "text/plain",
              "mediaLink": "https://url.to.my-folder"
            }]
          });

        test("should not make a request when there's no companyId", function(done) {
          storage.addEventListener("rise-storage-response", function(response) {
          });

          storage.go();
          assert.equal(requests.length, 0);
          done();
        });

        test("should get files in a bucket", function(done) {
          storage2.addEventListener("rise-storage-response", function(response) {
            assert.equal(response.detail.length, 2);
          });

          storage2.go();
          requests[0].respond(200, headers, multipleFiles);
          done();
        });

        test("should get files in a folder", function(done) {
          storage3.addEventListener("rise-storage-response", function(response) {
            assert.equal(response.detail.length, 2);
          });

          storage3.go();
          requests[0].respond(200, headers, multipleFiles);
          done();
        });

        test("should get a specific file in a bucket", function(done) {
          storage4.addEventListener("rise-storage-response", function(response) {
            assert.equal(response.detail.length, 1);
          });

          storage4.go();
          requests[0].respond(200, headers, bucketFile);
          done();
        });

        test("should get a specific file in a folder", function(done) {
          var singleFile = JSON.stringify({
            "items": [{
              "contentType": "image/jpeg",
              "mediaLink": "https://url.to.my-image.jpg"
            }]
          });

          storage5.addEventListener("rise-storage-response", function(response) {
            assert.equal(response.detail.length, 1);
          });

          storage5.go();
          requests[0].respond(200, headers, singleFile);
          done();
        });

        test("should return Rise Cache URLs for multiple files in a folder", function(done) {
          storage3.addEventListener("rise-storage-response", function(response) {
            assert.equal(response.detail.length, 2);
            assert.equal(response.detail[0], "http://localhost:9494/?url=https%3A//url.to.my-image.jpg");
            assert.equal(response.detail[1], "http://localhost:9494/?url=https%3A//url.to.my-image.gif");
          });

          storage3.isCacheRunning = true;
          storage3.go();
          requests[0].respond(200, headers, multipleFiles);
          done();
        });

        test("should return Rise Cache URLs for a specific file in a bucket", function(done) {
          storage4.addEventListener("rise-storage-response", function(response) {
            assert.equal(response.detail.length, 1);
            assert.equal(response.detail[0], "http://localhost:9494/?url=https%3A//url.to.my-image.jpg");
          });

          storage4.isCacheRunning = true;
          storage4.go();
          requests[0].respond(200, headers, bucketFile);
          done();
        });

        suite("rise-storage-response", function() {
          var responded;

          setup(function() {
            responded = false;
          });

          test("should fire rise-storage-response on success", function(done) {
            storage2.addEventListener("rise-storage-response", function(response) {
              responded = true;
            });

            storage2.go();
            requests[0].respond(200, headers, multipleFiles);
            assert.isTrue(responded);
            done();
          });

          test("should not fire rise-storage-response on failure", function(done) {
            storage2.addEventListener("rise-storage-response", function(response) {
              responded = true;
            });

            storage2.go();
            requests[0].respond(404, headers, multipleFiles);
            assert.isFalse(responded);
            done();
          });
        });

        suite("rise-storage-error", function() {
          var responded;

          setup(function() {
            responded = false;
          });

          test("should fire rise-storage-error on failure", function(done) {
            storage2.addEventListener("rise-storage-error", function(response) {
              responded = true;
            });

            storage2.go();
            requests[0].respond(404, headers, multipleFiles);
            assert.isTrue(responded);
            done();
          });

          test("should not fire rise-storage-error on success", function(done) {
            storage2.addEventListener("rise-storage-error", function(response) {
              responded = true;
            });

            storage2.go();
            requests[0].respond(200, headers, multipleFiles);
            assert.isFalse(responded);
            done();
          });
        });
      });

      suite("Ping request", function() {
        var headers = {
          "Content-Type": "text/plain"
        };

        test("should make a ping request with Rise Cache running", function(done) {
          storage2.$.ping.go();
          requests[0].respond(200, headers, "handlePingResponse();");

          // Ping request + storage request
          assert.equal(requests.length, 2);
          assert.isTrue(storage2.isCacheRunning);
          done();
        });

        test("should make a ping request with Rise Cache not running", function(done) {
          storage2.$.ping.go();
          requests[0].respond(200, headers, "");

          // Ping request + storage request
          assert.equal(requests.length, 2);
          assert.isFalse(storage2.isCacheRunning);
          done();
        });

        test("should error out on a ping request", function(done) {
          storage2.$.ping.go();
          requests[0].respond(404, headers, "handlePingResponse();");

          // Ping request + storage request
          assert.equal(requests.length, 2);
          assert.isFalse(storage2.isCacheRunning);
          done();
        });
      });

      suite("refresh", function() {
        var clock, pingSpy, timerSpy;

        suiteSetup(function() {
          clock = sinon.useFakeTimers();
        });

        suiteTeardown(function() {
          clock.restore();
        });

        test("should check for changes to a folder & enforce minimum refresh time", function() {
          pingSpy = sinon.spy(storage3.$.ping, "go");
          timerSpy = sinon.spy(storage3, "startTimer");

          storage3.startTimer();

          // startTimer should not fire after 10 minutes have elapsed (folderRefresh=10).
          clock.tick(600000);
          assert(pingSpy.notCalled);

          // Advance clock 5 minutes; startTimer should fire.
          clock.tick(300000);
          assert(pingSpy.calledOnce);
          assert(timerSpy.calledTwice);
        });

        test("should not check for changes to a file", function() {
          pingSpy = sinon.spy(storage4.$.ping, "go");
          timerSpy = sinon.spy(storage4, "startTimer");

          storage4.startTimer(pingSpy);
          clock.tick(10000);
          assert(pingSpy.notCalled);
          assert(timerSpy.calledOnce);
        });
      });

      suite("triggers", function() {
        test("should trigger request when companyId changed", function(done) {
          async.series([
            function(cb) {
              storage.companyId = "my-companyId";
              cb();
            },
            flush,
            function(cb) {
              requestAnimationFrame(function() {
                cb();
              });
            },
            function(cb) {
              assert.equal(requests.length, 1);
              cb();
            }
            ], done);
        });

        test("should trigger request when folder changed", function(done) {
          async.series([
            function(cb) {
              storage.folder = "new-folder";
              cb();
            },
            flush,
            function(cb) {
              requestAnimationFrame(function() {
                cb();
              });
            },
            function(cb) {
              assert.equal(requests.length, 1);
              cb();
            }
            ], done);
        });

        test("should trigger request when fileName changed", function(done) {
          async.series([
            function(cb) {
              storage.fileName = "new-fileName";
              cb();
            },
            flush,
            function(cb) {
              requestAnimationFrame(function() {
                cb();
              });
            },
            function(cb) {
              assert.equal(requests.length, 1);
              cb();
            }
            ], done);
        });
      });
    });
  </script>
</body>
</html>

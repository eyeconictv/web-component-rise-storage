<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../rise-storage.html">
</head>
<body>
  <rise-storage id="folder" companyId="abc123" folder="images"></rise-storage>
  <rise-storage id="file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>

  <script src="js/rise-storage-data.js"></script>
  <script>
    suite("rise-storage", function() {
      var responded,
        url = "",
        folder = document.querySelector("#folder"),
        fileFolder = document.querySelector("#file-folder");

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };
      });

      suiteTeardown(function() {
        xhr.restore();
      });

      setup(function() {
        requests = [];
        responded = false;
      });

      suite("folder", function() {
        test("should get a specific file in a folder", function(done) {
          var listener = function(response) {
            url = response.detail.files[0].url;

            assert.equal(response.detail.files.length, 1);
            assert.include(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media&cb=");
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, folderFile);
          done();
        });

        test("should return the same URL if the file has not changed", function(done) {
          var listener = function(response) {
            assert.equal(response.detail.files[0].url, url);
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, folderFile);
          done();
        });

        test("should return a different URL if the file has changed", function(done) {
          var listener = function(response) {
            assert.notEqual(response.detail.files[0].url, url);
            assert.include(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media&cb=");
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "CLDO+JDspcMCEAE="
            }]
          }));
          done();
        });

        test("should return added file", function(done) {
          var listener = function(response) {
            assert.equal(response.detail.files.length, 2);
            assert.include(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media&cb=");
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "CLDO+JDspcMCEAE="
            },
            {
              "name": "images/circle.png",
              "contentType": "image/png",
              "updated": "2015-02-06T14:25:11.312Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png",
              "etag": "CMiEudSn2MMCEAs="
            }]
          }));
          done();
        });

        test("should not return deleted file", function(done) {
          var listener = function(response) {
            assert.equal(response.detail.files.length, 1);
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "CLDO+JDspcMCEAE="
            }]
          }));
          done();
        });

        test("should still return a file when the etag is missing", function(done) {
          var listener = function(response) {
            assert.equal(response.detail.files.length, 1);
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            }]
          }));
          done();
        });

        test("should get files in a folder", function(done) {
          var listener = function(response) {
            assert.equal(response.detail.files.length, 8);
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, header, folderFiles);
          done();
        });
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../rise-storage.html">
</head>
<body>
  <rise-storage id="bucket" companyId="abc123"></rise-storage>
  <rise-storage id="folder" companyId="abc123" folder="my-folder"></rise-storage>
  <rise-storage id="file" companyId="abc123" fileName="circle.png"></rise-storage>

  <script src="js/rise-storage-data.js"></script>
  <script>
    suite("Rise Cache", function() {
      var bucket = document.querySelector("#bucket"),
        folder = document.querySelector("#folder"),
        file = document.querySelector("#file"),
        riseCacheHeader = { "Content-Type": "text/plain" };

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };
      });

      suiteTeardown(function() {
        xhr.restore();
      });

      setup(function() {
        requests = [];
      });

      test("should make a ping request with Rise Cache running", function(done) {
        bucket.$.ping.go();
        requests[0].respond(200, riseCacheHeader, "handlePingResponse();");

        // Ping request + storage request
        assert.equal(requests.length, 2);
        assert.isTrue(bucket.isCacheRunning);
        done();
      });

      test("should make a ping request with Rise Cache not running", function(done) {
        bucket.$.ping.go();
        requests[0].respond(200, riseCacheHeader, "");

        // Ping request + storage request
        assert.equal(requests.length, 2);
        assert.isFalse(bucket.isCacheRunning);
        done();
      });

      test("should error out on a ping request", function(done) {
        bucket.$.ping.go();
        requests[0].respond(404, riseCacheHeader, "handlePingResponse();");

        // Ping request + storage request
        assert.equal(requests.length, 2);
        assert.isFalse(bucket.isCacheRunning);
        done();
      });

      test("should return Rise Cache URLs for multiple files in a folder", function(done) {
        listener = function(response) {
          assert.equal(response.detail.files.length, 8);
          assert.equal(JSON.stringify(response.detail.files[0]),
            '{"url":"http://localhost:9494/?url=https%3A//www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%252Fhome.jpg?alt=media"}');
          assert.equal(JSON.stringify(response.detail.files[1]),
            '{"url":"http://localhost:9494/?url=https%3A//www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%252Fcircle.png?alt=media"}');
          folder.removeEventListener("rise-storage-response", listener);
        };

        folder.isCacheRunning = true;

        folder.addEventListener("rise-storage-response", listener);
        folder.go();
        requests[0].respond(200, header, folderFiles);
        done();
      });

      test("should return Rise Cache URLs for a specific file in a bucket", function(done) {
        listener = function(response) {
          assert.equal(response.detail.files.length, 1);
          assert.equal(JSON.stringify(response.detail.files[0]),
            '{"url":"http://localhost:9494/?url=https%3A//www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%252Fhome.jpg?alt=media"}');
          file.removeEventListener("rise-storage-response", listener);
        };

        file.isCacheRunning = true;

        file.addEventListener("rise-storage-response", listener);
        file.go();
        requests[0].respond(200, header, bucketFile);
        done();
      });
    });
  </script>
</body>
</html>

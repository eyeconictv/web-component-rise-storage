<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../../webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../rise-storage.html">
</head>
<body>
  <rise-storage id="noCompany"></rise-storage>
  <rise-storage id="bucket" companyId="abc123"></rise-storage>
  <rise-storage id="folder" companyId="abc123" folder="images"></rise-storage>
  <rise-storage id="file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>
  <rise-storage id="file-bucket" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="cache-folder" companyId="abc123" folder="images"></rise-storage>
  <rise-storage id="cache-file" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="content-type" companyId="abc123" folder="images" contentType="image/jpeg image/png"></rise-storage>
  <rise-storage id="image-file-type" companyId="abc123" folder="images" fileType="image"></rise-storage>
  <rise-storage id="video-file-type" companyId="abc123" folder="images" fileType="video"></rise-storage>

  <script src="../js/rise-storage-data.js"></script>
  <script>
    suite("rise-storage", function() {
      var responded,
        listener,
        clock,
        noCompany = document.querySelector("#noCompany"),
        bucket = document.querySelector("#bucket"),
        folder = document.querySelector("#folder"),
        fileFolder = document.querySelector("#file-folder"),
        cacheFolder = document.querySelector("#cache-folder"),
        cacheFile = document.querySelector("#cache-file"),
        fileBucket = document.querySelector("#file-bucket"),
        contentType = document.querySelector("#content-type"),
        imageFileType = document.querySelector("#image-file-type"),
        videoFileType = document.querySelector("#video-file-type"),
        suffix = "?alt=media",
        cacheHeader = { "Last-Modified": "Fri, 01 May 2015 15:32:11 GMT" };

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };

        clock = sinon.useFakeTimers();
      });

      suiteTeardown(function() {
        xhr.restore();
        clock.restore();
      });

      setup(function() {
        requests = [];
        responded = false;
      });

      suite("ready", function() {
        test("should set the number of supported image types", function() {
          bucket.ready();
          assert.equal(bucket._images.length, 5);
        });

        test("should set the number of supported video types", function() {
          bucket.ready();
          assert.equal(bucket._videos.length, 3);
        });

        test("should parse the contentType attribute", function() {
          contentType.ready();
          assert.equal(contentType._contentTypes.length, 2);
        });
      });

      suite("_computeStorageUrl", function() {
        test("should correctly set Storage request URL if no companyId attribute is specified", function() {
          noCompany._computeStorageUrl();
          assert.equal(noCompany.$.storage.url, "");
        });

        test("should correctly set Storage request URL for a folder", function() {
          folder._computeStorageUrl();
          assert.equal(folder.$.storage.url, "https://storage-dot-rvaserver2.appspot.com/_ah/api/storage/v0.01/files?companyId=abc123&folder=images/");
        });

        test("should correctly set Storage request URL for a file in a folder", function() {
          fileFolder._computeStorageUrl();
          assert.equal(fileFolder.$.storage.url, "https://storage-dot-rvaserver2.appspot.com/_ah/api/storage/v0.01/files?companyId=abc123&file=images/home.jpg");
        });

        test("should correctly set Storage request URL for a bucket", function() {
          bucket._computeStorageUrl();
          assert.equal(bucket.$.storage.url, "https://storage-dot-rvaserver2.appspot.com/_ah/api/storage/v0.01/files?companyId=abc123");
        });

        test("should correctly set Storage request URL for a file in a bucket", function() {
          fileBucket._computeStorageUrl();
          assert.equal(fileBucket.$.storage.url, "https://storage-dot-rvaserver2.appspot.com/_ah/api/storage/v0.01/files?companyId=abc123&file=home.jpg");
        });

        test("should correctly set Storage request URL for a folder that ends with a /", function() {
          folder.setAttribute("folder", "images/");
          folder._computeStorageUrl();
          assert.equal(folder.$.storage.url, "https://storage-dot-rvaserver2.appspot.com/_ah/api/storage/v0.01/files?companyId=abc123&folder=images%2F");
        });
      });

      suite("_handleStorageError", function() {
        test("should fire rise-storage-error if there is a problem with the Storage request", function(done) {
          var resp = {
            "xhr": {
              "status": 404,
              "statusText": "An error occurred"
            }
          },
          listener = function(response) {
            responded = true;
            fileBucket.removeEventListener("rise-storage-error", listener);
          };

          fileBucket.addEventListener("rise-storage-error", listener);
          fileBucket._handleStorageError({}, resp);
          assert.isTrue(responded);
          done();
        });
      });

      suite("_handleStorageFile", function() {
        suite("bucket file", function() {
          var url = bucketImage.selfLink;

          test("should return the correct URL for a specific file in a bucket", function(done) {
            listener = function(response) {
              responded = true;
              assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg?alt=media");
              fileBucket.removeEventListener("rise-storage-response", listener);
            };

            fileBucket.addEventListener("rise-storage-response", listener);
            fileBucket._fileUrl = url + suffix;
            fileBucket._handleStorageFile(bucketImage);

            assert.isTrue(responded);
            done();
          });

          test("should not fire rise-storage-response if the file hasn't changed", function(done) {
            listener = function(response) {
              responded = true;
            };

            fileBucket.addEventListener("rise-storage-response", listener);
            fileBucket._handleStorageFile(bucketImage);
            fileBucket.removeEventListener("rise-storage-response", listener);

            assert.isFalse(responded);
            done();
          });

          test("should return a new URL if the file has changed", function(done) {
            listener = function(response) {
              responded = true;
              assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg?alt=media&cb=0");
              fileBucket.removeEventListener("rise-storage-response", listener);
            };

            bucketImage.etag = "new";
            fileBucket.addEventListener("rise-storage-response", listener);
            fileBucket._handleStorageFile(bucketImage);

            assert.isTrue(responded);
            bucketImage.etag = "COjLvarr/cQCEAE=";
            done();
          });

          fileBucket._items = [];
        });

        suite("folder file", function() {
          var url = folderImage.items[0].selfLink;

          test("should return the correct URL for a specific file in a bucket", function(done) {
            listener = function(response) {
              responded = true;
              assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
              fileFolder.removeEventListener("rise-storage-response", listener);
            };

            fileFolder.addEventListener("rise-storage-response", listener);
            fileFolder._fileUrl = url + suffix;
            fileFolder._handleStorageFile(folderImage);

            assert.isTrue(responded);
            done();
          });

          test("should not fire rise-storage-response if the file hasn't changed", function(done) {
            listener = function(response) {
              responded = true;
            };

            fileFolder.addEventListener("rise-storage-response", listener);
            fileFolder._handleStorageFile(folderImage);
            fileFolder.removeEventListener("rise-storage-response", listener);

            assert.isFalse(responded);
            done();
          });

          test("should return a new URL if the file has changed", function(done) {
            listener = function(response) {
              responded = true;
              assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media&cb=0");
              fileFolder.removeEventListener("rise-storage-response", listener);
            };

            folderImage.items[0].etag = "new";
            fileFolder.addEventListener("rise-storage-response", listener);
            fileFolder._handleStorageFile(folderImage);

            assert.isTrue(responded);
            folderImage.items[0].etag = "COjLvarr/cQCEAE=";
            done();
          });

          fileFolder._items = [];
        });
      });

      suite("_handleStorageFolder", function() {
        test("should return the correct URLs for files in a folder", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 3);
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media");
            assert.equal(response.detail.files[2].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder._handleStorageFolder(images);

          assert.isTrue(responded);
          done();
        });

        test("should return the same URLs if none of the files have changed", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 3);
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media");
            assert.equal(response.detail.files[2].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder._handleStorageFolder(images);

          assert.isTrue(responded);
          done();
        });

        test("should return new URL if a file has changed", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 3);
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media&cb=0");
            folder.removeEventListener("rise-storage-response", listener);
          };

          images.items[2].etag = "new";
          folder.addEventListener("rise-storage-response", listener);
          folder._handleStorageFolder(images);

          assert.isTrue(responded);
          done();
        });

        test("should return URL of a file that has been added to a folder", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 4);
            assert.equal(response.detail.files[3].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fgolf.svg?alt=media&cb=0");
            folder.removeEventListener("rise-storage-response", listener);
          };

          images.items.push({
            "name": "images/golf.svg",
            "contentType": "image/svg+xml",
            "updated": "2015-01-30T08:19:09.263Z",
            "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fgolf.svg",
            "etag": "CPjC1qHc7MQCEAE="
          });
          folder.addEventListener("rise-storage-response", listener);
          folder._handleStorageFolder(images);

          assert.isTrue(responded);
          done();
        });

        test("should not return URL of a file that has been removed from a folder", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 3);
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media&cb=0");
            assert.equal(response.detail.files[2].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media");
            folder.removeEventListener("rise-storage-response", listener);
          };

          images.items.pop();
          folder.addEventListener("rise-storage-response", listener);
          folder._handleStorageFolder(images);

          assert.isTrue(responded);
          images.items[2].etag = "CMiEudSn2MMCEAs=";
          done();
        });

        folder._items = [];

        suite("Rise Cache", function() {
          test("should return the correct URLs for files in a folder", function(done) {
            var listener = function(response) {
              responded = true;
              assert.equal(response.detail.files.length, 3);
              assert.equal(response.detail.files[0].url, "http://localhost:9494/?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fhome.jpg%3Falt%3Dmedia");
              assert.equal(response.detail.files[1].url, "http://localhost:9494/?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fcircle.png%3Falt%3Dmedia");
              assert.equal(response.detail.files[2].url, "http://localhost:9494/?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fmy-image.bmp%3Falt%3Dmedia");
              cacheFolder.removeEventListener("rise-storage-response", listener);
            };

            cacheFolder._isCacheRunning = true;
            cacheFolder.addEventListener("rise-storage-response", listener);
            cacheFolder._handleStorageFolder(images);

            assert.isTrue(responded);
            done();
          });

          test("should return new URLs if none of the files have changed", function(done) {
            var listener = function(response) {
              responded = true;
              assert.equal(response.detail.files.length, 3);
              assert.equal(response.detail.files[0].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fhome.jpg%3Falt%3Dmedia");
              assert.equal(response.detail.files[1].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fcircle.png%3Falt%3Dmedia");
              assert.equal(response.detail.files[2].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fmy-image.bmp%3Falt%3Dmedia");
              cacheFolder.removeEventListener("rise-storage-response", listener);
            };

            cacheFolder.addEventListener("rise-storage-response", listener);
            cacheFolder._handleStorageFolder(images);

            assert.isTrue(responded);
            done();
          });

          test("should return new URL if a file has changed", function(done) {
            var listener = function(response) {
              responded = true;
              assert.equal(response.detail.files.length, 3);
              assert.equal(response.detail.files[1].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fcircle.png%3Falt%3Dmedia");
              cacheFolder.removeEventListener("rise-storage-response", listener);
            };

            images.items[2].etag = "new";
            cacheFolder.addEventListener("rise-storage-response", listener);
            cacheFolder._handleStorageFolder(images);

            assert.isTrue(responded);
            done();
          });

          test("should return URL of a file that has been added to a folder", function(done) {
            var listener = function(response) {
              responded = true;
              assert.equal(response.detail.files.length, 4);
              assert.equal(response.detail.files[3].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fgolf.svg%3Falt%3Dmedia");
              cacheFolder.removeEventListener("rise-storage-response", listener);
            };

            images.items.push({
              "name": "images/golf.svg",
              "contentType": "image/svg+xml",
              "updated": "2015-01-30T08:19:09.263Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fgolf.svg",
              "etag": "CPjC1qHc7MQCEAE="
            });
            cacheFolder.addEventListener("rise-storage-response", listener);
            cacheFolder._handleStorageFolder(images);

            assert.isTrue(responded);
            done();
          });

          test("should not return URL of a file that has been removed from a folder", function(done) {
            var listener = function(response) {
              responded = true;
              assert.equal(response.detail.files.length, 3);
              assert.equal(response.detail.files[0].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fhome.jpg%3Falt%3Dmedia");
              assert.equal(response.detail.files[1].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fcircle.png%3Falt%3Dmedia");
              assert.equal(response.detail.files[2].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fwww.googleapis.com%2Fstorage%2Fv1%2Fb%2Frisemedialibrary-abc123%2Fo%2Fimages%252Fmy-image.bmp%3Falt%3Dmedia");
              cacheFolder.removeEventListener("rise-storage-response", listener);
            };

            images.items.pop();
            cacheFolder.addEventListener("rise-storage-response", listener);
            cacheFolder._handleStorageFolder(images);

            assert.isTrue(responded);
            images.items[2].etag = "CMiEudSn2MMCEAs=";
            done();
          });

          cacheFolder._items = [];
        });
      });

      suite("_getFileFromCache", function() {
        bucket._fileUrl = "http://url.to.my.file";

        test("should correctly set the cache URL when loading", function() {
          bucket._isLoading = true;
          bucket._getFileFromCache();
          assert.equal(bucket._cacheUrl, "http://localhost:9494/?url=http://url.to.my.file");
        });

        test("should correctly set the cache URL when not loading", function() {
          bucket._isLoading = false;
          bucket._getFileFromCache();
          assert.equal(bucket._cacheUrl, "http://localhost:9494/cb=0?url=http://url.to.my.file");
        });
      });

      suite("_getFilesFromCache", function() {
        test("should correctly set number of total files in a folder", function() {
          folder._getFilesFromCache(images);
          assert.equal(folder._totalFiles, 3);
        });
      });

      suite("_handleCacheFile", function() {
        // Covered in e2e tests.
      });

      suite("_handleCacheFolder", function() {
        // Covered in e2e tests.
      });

      suite("_handleCacheError", function() {
        test("should fire rise-storage-error if there is a problem with the Rise Cache request", function(done) {
          var resp = {
            "xhr": {
              "status": 404,
              "statusText": "An error occurred"
            }
          },
          listener = function(response) {
            responded = true;
            fileBucket.removeEventListener("rise-storage-error", listener);
          };

          fileBucket.addEventListener("rise-storage-error", listener);
          fileBucket._handleCacheError({}, resp);
          assert.isTrue(responded);
          done();
        });
      });

      suite("_handlePingResponse", function() {
        test("should correctly set _isCacheRunning and _pingReceived if ping response is an empty string", function() {
          fileBucket._handlePingResponse({}, { "response": "" });
          assert.equal(fileBucket._isCacheRunning, false);
          assert.equal(fileBucket._pingReceived, true);
        });

        test("should correctly set _isCacheRunning and _pingReceived if ping response is not an empty string", function() {
          fileBucket._handlePingResponse({}, { "response": "_handlePingResponse();" });
          assert.equal(fileBucket._isCacheRunning, true);
          assert.equal(fileBucket._pingReceived, true);
        });
      });

      suite("_handlePingError", function() {
        test("should correctly set _isCacheRunning and _pingReceived if a ping error occurs", function() {
          var resp = {
            "xhr": {
              "status": 404,
              "statusText": "An error occurred"
            }
          };

          fileBucket._handlePingError({}, resp);
          assert.equal(fileBucket._isCacheRunning, false);
          assert.equal(fileBucket._pingReceived, true);
        });
      });

      suite("_startTimer", function() {
        var timerSpy;

        test("should correctly set refresh interval", function() {
          folder.refresh = 10;
          folder._startTimer();
          assert.equal(folder.refresh, 10);
        });

        test("should enforce a minimum refresh interval", function() {
          folder.refresh = 1;
          folder._startTimer();
          assert.equal(folder.refresh, 5);
        });

        test("should check for changes to a cached file", function() {
          timerSpy = sinon.spy(fileBucket, "_getFileFromCache");

          fileBucket.refresh = 5;
          fileBucket._isFile = true;
          fileBucket._isCacheRunning = true;
          fileBucket._startTimer();

          clock.tick(300000);
          assert(timerSpy.calledOnce);
        });

        test("should check for changes to an uncached file", function() {
          timerSpy = sinon.spy(fileBucket.$.storage, "generateRequest");

          fileBucket._isCacheRunning = false;
          fileBucket._startTimer();

          clock.tick(300000);
          assert(timerSpy.calledOnce);
        });

        test("should check for changes to a folder", function() {
          timerSpy = sinon.spy(folder.$.storage, "generateRequest");

          folder._isFile = false;
          folder._startTimer();

          clock.tick(300000);
          assert(timerSpy.calledOnce);
        });
      });

      suite("_setIsFile", function() {
        var isFile;

        test("should correctly set _isFile for a file in the root of the bucket", function() {
          fileBucket._setIsFile(bucketImage);
          assert.equal(fileBucket._isFile, true);
        });

        test("should correctly set _isFile for a file in a folder", function() {
          fileFolder._setIsFile(folderImage);
          assert.equal(fileFolder._isFile, true);
        });

        test("should correctly set _isFile for a folder", function() {
          isFile = folder._setIsFile(images);
          assert.equal(folder._isFile, false);
        });
      });

      suite("_setFileUrl", function() {
        test("should correctly set fileUrl for a file in the root of the bucket when Rise Cache is running", function() {
          fileBucket._isCacheRunning = true;
          fileBucket._setFileUrl(bucketImage);
          assert.equal(fileBucket._fileUrl, "https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");
        });

        test("should correctly set _fileUrl for a file in a folder when Rise Cache is running", function() {
          fileFolder._isCacheRunning = true;
          fileFolder._setFileUrl(folderImage);
          assert.equal(fileFolder._fileUrl, "https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
        });

        test("should correctly set fileUrl for a file in the root of the bucket when Rise Cache is not running", function() {
          fileBucket._isCacheRunning = false;
          fileBucket._setFileUrl(bucketImage);
          assert.equal(fileBucket._fileUrl, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg" + suffix);
        });

        test("should correctly set fileUrl for a file in a folder when Rise Cache is not running", function() {
          fileFolder._isCacheRunning = false;
          fileFolder._setFileUrl(folderImage);
          assert.equal(fileFolder._fileUrl, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg" + suffix);
        });
      });

      suite("_filterFiles", function() {
        test("should return true if no fileType or contentType attribute is provided", function() {
          assert.equal(fileBucket._filterFiles("image/jpeg"), true);
        });
      });

      suite("_filterByContentType", function() {
        test("should return true if a content type matches one of the contentType attribute values", function() {
          assert.equal(contentType._filterByContentType("image/jpeg"), true);
        });

        test("should return false if a content type does not match one of the contentType attribute values", function() {
          assert.equal(contentType._filterByContentType("video/webm"), false);
        });
      });

      suite("_filterByFileType", function() {
        test("should return true when filtering by image and the content type is a jpeg", function() {
          assert.equal(imageFileType._filterByFileType("image/jpeg"), true);
        });

        test("should return false when filtering by image and the content type is a webm", function() {
          assert.equal(imageFileType._filterByFileType("video/webm"), false);
        });

        test("should return true when filtering by video and the content type is a webm", function() {
          assert.equal(videoFileType._filterByFileType("video/webm"), true);
        });

        test("should return false when filtering by video and the content type is a jpeg", function() {
          assert.equal(videoFileType._filterByFileType("image/jpeg"), false);
        });
      });

      suite("_sortFiles", function() {
        var filesByName =
          [{
            "sortBy": "images/home.jpg",
            "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
          },
          {
            "sortBy": "images/circle.png",
            "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
          },
          {
            "sortBy": "images/my-image.bmp",
            "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
          }],
          filesByDate =
          [{
              sortBy: 1423221853313,  // "2015-02-06T11:24:13.313Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
            },
            {
              sortBy: 1422605949263,  // "2015-01-30T08:19:09.263Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            },
            {
              sortBy: 1423071991263,  // "2015-02-04T17:46:31.263Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
          }],
          sortedFiles;

        test("should sort by name in ascending order", function() {
          folder.sort = "name";
          folder.sortdirection = "asc";
          sortedFiles = JSON.stringify(folder._sortFiles(filesByName));

          assert.equal(sortedFiles, JSON.stringify([
            {
              sortBy: "images/circle.png",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
            },
            {
              sortBy: "images/home.jpg",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            },
            {
              sortBy: "images/my-image.bmp",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
            }]
          ));
        });

        test("should sort by name in descending order", function() {
          folder.sort = "name";
          folder.sortdirection = "desc";
          sortedFiles = JSON.stringify(folder._sortFiles(filesByName));

          assert.equal(sortedFiles, JSON.stringify([
            {
              sortBy: "images/my-image.bmp",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
            },
            {
              sortBy: "images/home.jpg",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            },
            {
              sortBy: "images/circle.png",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
            }]
          ));
        });

        test("should sort by date in ascending order", function() {
          folder.sort = "date";
          folder.sortdirection = "asc";
          sortedFiles = JSON.stringify(folder._sortFiles(filesByDate));

          assert.equal(sortedFiles, JSON.stringify([
            {
              sortBy: 1422605949263,  // "2015-01-30T08:19:09.263Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            },
            {
              sortBy: 1423071991263,  // "2015-02-04T17:46:31.263Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
            },
            {
              sortBy: 1423221853313,  // "2015-02-06T11:24:13.313Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
            }]
          ));
        });

        test("should sort by date in descending order", function() {
          folder.sort = "date";
          folder.sortdirection = "desc";
          sortedFiles = JSON.stringify(folder._sortFiles(filesByDate));

          assert.equal(sortedFiles, JSON.stringify([
            {
              sortBy: 1423221853313,  // "2015-02-06T11:24:13.313Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
            },
            {
              sortBy: 1423071991263,  // "2015-02-04T17:46:31.263Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
            },
            {
              sortBy: 1422605949263,  // "2015-01-30T08:19:09.263Z"
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            }]
          ));
        });

        test("should sort in random order", function() {
          folder.sort = "random";
          sortedFiles = folder._sortFiles(filesByName);

          // Not possible to predict what order files will be returned in, only that they are returned.
          assert.equal(sortedFiles.length, 3);
        });

        test("should sort in ascending order when no sortDirection is provided", function() {
          folder.sort = "name";
          folder.sortdirection = null;
          sortedFiles = JSON.stringify(folder._sortFiles(filesByName));

          assert.equal(sortedFiles, JSON.stringify([
            {
              sortBy: "images/circle.png",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
            },
            {
              sortBy: "images/home.jpg",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
            },
            {
              sortBy: "images/my-image.bmp",
              url: "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
            }]
          ));
        });
      });

      suite("_prepareResponse", function() {
        var response,
          files =
          [{
            "sortBy": "images/home.jpg",
            "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
          },
          {
            "sortBy": "images/circle.png",
            "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
          },
          {
            "sortBy": "images/my-image.bmp",
            "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
          }];

        test("should return an empty object when an empty array is passed in", function() {
          response = JSON.stringify(folder._prepareResponse([]));

          assert.equal(response, JSON.stringify( { "files": [] } ));
        });

        test("should return an object containing a sorted list of files", function() {
          folder.sort = "name";
          response = JSON.stringify(folder._prepareResponse(files));
          result = {
            "files": [
              {
                "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png"
              },
              {
                "url": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg"
              },
              {
                "url":"https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp"
              }
            ]};

          assert.equal(response, JSON.stringify(result));
        });
      });
    });
  </script>
</body>
</html>

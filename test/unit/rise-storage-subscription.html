<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../../webcomponentsjs/webcomponents-lite.min.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../rise-storage.html">
</head>
<body>
<rise-storage id="file-bucket" companyId="abc123" fileName="home.jpg"></rise-storage>

<script src="../js/rise-storage-data.js"></script>
<script>
suite("rise-storage", function() {
  var responded,
    listener,
    fileBucket = document.querySelector("#file-bucket");


  suiteSetup(function() {
    xhr = sinon.useFakeXMLHttpRequest();

    xhr.onCreate = function (xhr) {
      requests.push(xhr);
    };

    clock = sinon.useFakeTimers();
  });

  suiteTeardown(function() {
    xhr.restore();
    clock.restore();
  });

  setup(function() {
    requests = [];
    responded = false;
  });

  suite("_computeStorageUrl", function() {
    test("should correctly set Storage request URL", function() {
      fileBucket._getStorageSubscription();
      assert.equal(fileBucket.$.storageSubscription.url, "https://store-dot-rvaserver2.appspot.com/v1/company/abc123/product/status?pc=b0cba08a4baa0c62b8cdc621b6f6a124f89a03db");
    });

    test("should correctly check that subscription is expired", function() {
      var expiredResponse = [{"pc":"b0cba08a4baa0c62b8cdc621b6f6a124f89a03db","status":"Trial Expired","expiry":null,"trialPeriod":0}];
      assert.isTrue(fileBucket._isExpired(expiredResponse));
    });

    test("should correctly check that subscription is not expired", function() {
      var expiredResponse = [{"pc":"b0cba08a4baa0c62b8cdc621b6f6a124f89a03db","status":"Subscribed","expiry":null,"trialPeriod":0}];
      assert.isFalse(fileBucket._isExpired(expiredResponse));
    });

    test("should fire rise-storage-subscription-expired if subscription is expired", function(done) {
      var expiredResponse = { response: [
            {"pc": "b0cba08a4baa0c62b8cdc621b6f6a124f89a03db", "status": "Trial Expired", "expiry": null, "trialPeriod": 0}
          ]
        };
      var responded = false;
      var listener = function() {
        responded = true;
        fileBucket.removeEventListener("rise-storage-subscription-expired", listener);
      };

      fileBucket.addEventListener("rise-storage-subscription-expired", listener);
      fileBucket._handleStorageSubscriptionResponse( null, expiredResponse);

      assert.isTrue(responded);
      done();
    });

    test("should not fire rise-storage-subscription-expired if subscription is not expired", function(done) {
      var expiredResponse = { response: [
        {"pc": "b0cba08a4baa0c62b8cdc621b6f6a124f89a03db", "status": "Subscribed", "expiry": null, "trialPeriod": 0}
      ]
      };
      var responded = false;
      var listener = function() {
        responded = true;
        fileBucket.removeEventListener("rise-storage-subscription-expired", listener);
      };

      fileBucket.addEventListener("rise-storage-subscription-expired", listener);
      fileBucket._handleStorageSubscriptionResponse( null, expiredResponse);

      assert.isFalse(responded);
      done();
    });

    test("should fire rise-storage-subscription-error if there is an error on the call to get subscription status", function(done) {
      var responded = false;
      var response = {
          "xhr": {
            "status": 404,
            "statusText": "An error occurred"
          }
        },
      listener = function() {
        responded = true;
        fileBucket.removeEventListener("rise-storage-subscription-error", listener);
      };

      fileBucket.addEventListener("rise-storage-subscription-error", listener);
      fileBucket._handleStorageSubscriptionError( {}, response);

      assert.isTrue(responded);
      done();
    });
  });
});
</script>
</body>
</html>

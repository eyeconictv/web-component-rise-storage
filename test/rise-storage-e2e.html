<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>rise-storage</title>

  <script src="../../webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../rise-storage.html">
</head>
<body>
  <rise-storage id="folder" companyId="abc123" folder="images"></rise-storage>
  <rise-storage id="file" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>
  <rise-storage id="cache-folder" companyId="abc123" folder="images"></rise-storage>
  <rise-storage id="cache-file" companyId="abc123" fileName="home.jpg"></rise-storage>
  <rise-storage id="cache-file-folder" companyId="abc123" folder="images" fileName="home.jpg"></rise-storage>
  <rise-storage id="file-type" companyId="abc123" folder="my-folder" fileType="image"></rise-storage>
  <rise-storage id="content-type" companyId="abc123" folder="my-folder" contentType="image/jpeg image/png"></rise-storage>

  <script src="js/rise-storage-data.js"></script>
  <script>
    suite("rise-storage", function() {
      var responded,
        listener,
        folder = document.querySelector("#folder"),
        file = document.querySelector("#file"),
        fileFolder = document.querySelector("#file-folder"),
        cacheFolder = document.querySelector("#cache-folder"),
        cacheFile = document.querySelector("#cache-file"),
        cacheFileFolder = document.querySelector("#cache-file-folder"),
        fileType = document.querySelector("#file-type"),
        contentType = document.querySelector("#content-type"),
        cacheHeader = { "Last-Modified": "Fri, 01 May 2015 15:32:11 GMT" };

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };

        clock = sinon.useFakeTimers();
      });

      suiteTeardown(function() {
        xhr.restore();
        clock.restore();
      });

      setup(function() {
        requests = [];
        responded = false;
      });

      suite("bucket file", function() {
        test("should return the correct URL for a specific file in a bucket", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg?alt=media");
            file.removeEventListener("rise-storage-response", listener);
          };

          file.addEventListener("rise-storage-response", listener);
          file.go();
          requests[0].respond(200, header, bucketFile);
          assert.isTrue(responded);
          done();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          var listener = function(response) {
            responded = true;
            file.removeEventListener("rise-storage-response", listener);
          };

          file.addEventListener("rise-storage-response", listener);
          file.go();
          requests[0].respond(200, header, bucketFile);
          assert.isFalse(responded);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg?alt=media&cb=0");
            file.removeEventListener("rise-storage-response", listener);
          };

          file.addEventListener("rise-storage-response", listener);
          file.go();
          requests[0].respond(200, header, JSON.stringify({
            "name": "home.jpg",
            "contentType": "image/jpeg",
            "updated": "2015-02-04T17:45:25.945Z",
            "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/home.jpg",
            "etag": "new"
          }));
          assert.isTrue(responded);
          done();
        });

        file.items = [];
      });

      suite("folder file", function() {
        test("should return the correct URL for a specific file in a folder", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, folderFile);
          assert.isTrue(responded);
          done();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          var listener = function(response) {
            responded = true;
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, folderFile);
          assert.isFalse(responded);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media&cb=0");
            fileFolder.removeEventListener("rise-storage-response", listener);
          };

          fileFolder.addEventListener("rise-storage-response", listener);
          fileFolder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "new"
            }]
          }));
          assert.isTrue(responded);
          done();
        });

        fileFolder.items = [];
      });

      suite("Rise Cache - bucket file", function() {
        test("should return the correct URL for a specific file in a bucket", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");
            cacheFile.removeEventListener("rise-storage-response", listener);
          };

          cacheFile.isCacheRunning = true;

          cacheFile.addEventListener("rise-storage-response", listener);
          cacheFile.go();
          requests[0].respond(200, header, bucketFile);
          requests[1].respond(200, cacheHeader, "");

          assert.isTrue(responded);
          done();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          var listener = function(response) {
            responded = true;
            cacheFile.removeEventListener("rise-storage-response", listener);
          };

          cacheFile.addEventListener("rise-storage-response", listener);
          cacheFile.go();
          requests[0].respond(200, header, bucketFile);
          requests[1].respond(200, cacheHeader, "");

          assert.isFalse(responded);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fhome.jpg");
            cacheFile.removeEventListener("rise-storage-response", listener);
          };

          cacheFile.addEventListener("rise-storage-response", listener);
          cacheFile.go();
          requests[0].respond(200, header, bucketFile);
          requests[1].respond(200, { "Last-Modified": "Thu, 23 Apr 2015 09:18:55 GMT" }, "");
          assert.isTrue(responded);
          done();
        });

        cacheFile.items = [];
      });

      suite("Rise Cache - folder file", function() {
        test("should return the correct URL for a specific file in a folder", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "http://localhost:9494/?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
            cacheFileFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFileFolder.isCacheRunning = true;

          cacheFileFolder.addEventListener("rise-storage-response", listener);
          cacheFileFolder.go();
          requests[0].respond(200, header, folderFile);
          requests[1].respond(200, cacheHeader, "");

          assert.isTrue(responded);
          done();
        });

        test("should not fire rise-storage-response if the file hasn't changed", function(done) {
          var listener = function(response) {
            responded = true;
            cacheFileFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFileFolder.addEventListener("rise-storage-response", listener);
          cacheFileFolder.go();
          requests[0].respond(200, header, folderFile);
          requests[1].respond(200, cacheHeader, "");

          assert.isFalse(responded);
          done();
        });

        test("should return a new URL if the file has changed", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
            cacheFileFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFileFolder.addEventListener("rise-storage-response", listener);
          cacheFileFolder.go();
          requests[0].respond(200, header, folderFiles);
          requests[1].respond(200, { "Last-Modified": "Thu, 23 Apr 2015 09:18:55 GMT" }, "");
          assert.isTrue(responded);
          done();
        });

        cacheFileFolder.items = [];
      });

      suite("folder", function() {
        test("should return the correct URLs for files in a folder", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, header, folderImages);
          assert.isTrue(responded);
          done();
        });

        test("should return the same URLs if none of the files have changed", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media");
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, header, folderImages);
          assert.isTrue(responded);
          done();
        });

        test("should return new URL if a file has changed", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media&cb=0");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/",
              "contentType": "text/plain",
              "updated": "2015-02-04T17:44:00.549Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2F",
              "etag": "CIjxrtzryMMCEAE="
            },
            {
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "COjLvarr/cQCEAE="
            },
            {
              "name": "images/circle.png",
              "contentType": "image/png",
              "updated": "2015-02-06T14:25:11.312Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png",
              "etag": "new"
            }]
          }));
          assert.isTrue(responded);
          done();
        });

        test("should return URL of a file that has been added to a folder", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 3);
            assert.equal(response.detail.files[2].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp?alt=media&cb=0");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/",
              "contentType": "text/plain",
              "updated": "2015-02-04T17:44:00.549Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2F",
              "etag": "CIjxrtzryMMCEAE="
            },
            {
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "new"
            },
            {
              "name": "images/circle.png",
              "contentType": "image/png",
              "updated": "2015-02-06T14:25:11.312Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png",
              "etag": "new"
            },
            {
              "name": "images/my-image.bmp",
              "contentType": "image/bmp",
              "updated": "2015-02-06T11:24:13.313Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp",
              "etag": "CJi3zten2MMCEA0="
            }]
          }));
          assert.isTrue(responded);
          done();
        });

        test("should not return URL of a file that has been removed from a folder", function(done) {
          var listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 2);
            assert.equal(response.detail.files[0].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg?alt=media&cb=0");
            assert.equal(response.detail.files[1].url, "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png?alt=media&cb=0");
            folder.removeEventListener("rise-storage-response", listener);
          };

          folder.addEventListener("rise-storage-response", listener);
          folder.go();
          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/",
              "contentType": "text/plain",
              "updated": "2015-02-04T17:44:00.549Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2F",
              "etag": "CIjxrtzryMMCEAE="
            },
            {
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "new"
            },
            {
              "name": "images/circle.png",
              "contentType": "image/png",
              "updated": "2015-02-06T14:25:11.312Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png",
              "etag": "new"
            }]
          }));
          assert.isTrue(responded);
          done();
        });

        folder.items = [];
      });

      suite("Rise Cache - folder", function() {
        test("should return the correct URLs for files in a folder", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files[0].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
            assert.equal(response.detail.files[1].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png");
            cacheFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFolder.isCacheRunning = true;

          cacheFolder.addEventListener("rise-storage-response", listener);
          cacheFolder.go();

          requests[0].respond(200, header, folderImages);
          requests[1].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
          requests[2].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png";
          requests[1].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");
          requests[2].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");

          assert.isTrue(responded);
          done();
        });

        test("should not fire rise-storage-response if none of the files have changed", function(done) {
          listener = function(response) {
            responded = true;
          };

          cacheFolder.addEventListener("rise-storage-response", listener);
          cacheFolder.go();

          requests[0].respond(200, header, folderImages);
          requests[1].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
          requests[2].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png";
          requests[1].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");
          requests[2].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");

          cacheFolder.removeEventListener("rise-storage-response", listener);
          assert.isFalse(responded);
          done();
        });

        test("should fire rise-storage-response if a file has changed", function(done) {
          listener = function(response) {
            responded = true;
            cacheFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFolder.addEventListener("rise-storage-response", listener);
          cacheFolder.go();

          requests[0].respond(200, header, folderImages);
          requests[1].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
          requests[2].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png";
          requests[1].respond(200, cacheHeader, "");
          requests[2].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");

          assert.isTrue(responded);
          done();
        });

        test("should return URL of a file that has been added to a folder", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 3);
            assert.equal(response.detail.files[2].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fmy-image.bmp");
            cacheFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFolder.addEventListener("rise-storage-response", listener);
          cacheFolder.go();

          requests[0].respond(200, header, JSON.stringify({
            "items": [{
              "name": "images/",
              "contentType": "text/plain",
              "updated": "2015-02-04T17:44:00.549Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2F",
              "etag": "CIjxrtzryMMCEAE="
            },
            {
              "name": "images/home.jpg",
              "contentType": "image/jpeg",
              "updated": "2015-02-04T17:45:25.945Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fhome.jpg",
              "etag": "COjLvarr/cQCEAE="
            },
            {
              "name": "images/circle.png",
              "contentType": "image/png",
              "updated": "2015-02-06T14:25:11.312Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fcircle.png",
              "etag": "CMiEudSn2MMCEAs="
            },
            {
              "name": "images/my-image.bmp",
              "contentType": "image/bmp",
              "updated": "2015-02-06T11:24:13.313Z",
              "selfLink": "https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/images%2Fmy-image.bmp",
              "etag": "CJi3zten2MMCEA0="
            }]
          }));
          requests[1].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
          requests[2].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png";
          requests[3].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fmy-image.bmp";
          requests[1].respond(200, cacheHeader, "");
          requests[2].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");
          requests[3].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");

          assert.isTrue(responded);
          done();
        });

        test("should not return URL of a file that has been removed from a folder", function(done) {
          listener = function(response) {
            responded = true;
            assert.equal(response.detail.files.length, 2);
            assert.equal(response.detail.files[0].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg");
            assert.equal(response.detail.files[1].url, "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png");
            cacheFolder.removeEventListener("rise-storage-response", listener);
          };

          cacheFolder.addEventListener("rise-storage-response", listener);
          cacheFolder.go();

          requests[0].respond(200, header, folderImages);
          requests[1].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fhome.jpg";
          requests[2].responseURL = "http://localhost:9494/cb=0?url=https%3A%2F%2Fstorage.googleapis.com%2Frisemedialibrary-abc123%2Fimages%252Fcircle.png";
          requests[1].respond(200, cacheHeader, "");
          requests[2].respond(200, { "Last-Modified": "Fri, 24 Apr 2015 15:32:11 GMT" }, "");

          assert.isTrue(responded);
          done();
        });

        cacheFolder.items = [];
      });
    });
  </script>
</body>
</html>

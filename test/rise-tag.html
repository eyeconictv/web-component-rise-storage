<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>Tagging</title>

  <script src="../../webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../rise-storage.html">
  <link rel="import" href="../../rise-tag/rise-tag.html">
</head>
<body>
  <rise-storage id="tagging" companyId="abc123">
    <rise-tag type="lookup" name="brand"></rise-tag>
  </rise-storage>

  <script src="js/rise-tag-data.js"></script>
  <script>
    suite("rise-tag", function() {
      var tagging = document.querySelector("#tagging");

      suiteSetup(function() {
        xhr = sinon.useFakeXMLHttpRequest();

        xhr.onCreate = function (xhr) {
          requests.push(xhr);
        };
      });

      suiteTeardown(function() {
        xhr.restore();
      });

      setup(function() {
        requests = [];
      });

      suite("requests", function() {
        var riseTag = document.querySelector("rise-tag");

        test("should set tagging request body when 'type' and 'name' attributes are set", function(done) {
          var elem = document.createElement("rise-tag");

          elem.setAttribute("type", "freeform");
          elem.setAttribute("name", "discount");
          tagging.appendChild(elem);
          tagging.go();

          assert.equal(tagging.body, '{"companyId":"abc123","tags":[{"type":"lookup","name":"brand"},{"type":"freeform","name":"discount"}]}');
          done();
        });

        test("should get Storage file", function(done) {
          listener = function(response) {
            assert.equal(response.detail.files.length, 1);
            assert.equal(JSON.stringify(response.detail.files[0]),
              '{"url":"https://www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/125px-Link_Bow.png?alt=media","tags":[{"type":"LOOKUP","name":"brand","value":"nike"},{"type":"FREEFORM","name":"discount","value":"10% off"},{"type":"FREEFORM","name":"special","value":"2 for 1"}],"timeline":{"type":"TIMELINE","timeDefined":true,"duration":60,"pud":"false","trash":"false","carryon":"false","startDate":"01/30/15 12:00 AM","endDate":"01/31/15 12:00 AM","startTime":null,"endTime":null,"recurrenceOptions":null}}');

            tagging.removeEventListener("rise-storage-response", listener);
          };

          tagging.addEventListener("rise-storage-response", listener);
          tagging.go();
          requests[0].respond(200, header, single);
          done();
        });

        test("should get Rise Cache file", function(done) {
          listener = function(response) {
            assert.equal(response.detail.files.length, 1);
            assert.equal(JSON.stringify(response.detail.files[0]),
              '{"url":"http://localhost:9494/?url=https%3A//www.googleapis.com/storage/v1/b/risemedialibrary-abc123/o/125px-Link_Bow.png%3Falt%3Dmedia","tags":[{"type":"LOOKUP","name":"brand","value":"nike"},{"type":"FREEFORM","name":"discount","value":"10% off"},{"type":"FREEFORM","name":"special","value":"2 for 1"}],"timeline":{"type":"TIMELINE","timeDefined":true,"duration":60,"pud":"false","trash":"false","carryon":"false","startDate":"01/30/15 12:00 AM","endDate":"01/31/15 12:00 AM","startTime":null,"endTime":null,"recurrenceOptions":null}}');

            tagging.removeEventListener("rise-storage-response", listener);
          };

          tagging.isCacheRunning = true;
          tagging.addEventListener("rise-storage-response", listener);
          tagging.go();
          requests[0].respond(200, header, single);
          done();
        });

        test("should set tagging request body when 'type', 'name' and 'value' attributes are set", function(done) {
          document.querySelector("rise-tag").setAttribute("value", "nike");
          tagging.go();

          assert.equal(tagging.body, '{"companyId":"abc123","tags":[{"type":"lookup","name":"brand","value":"nike"},{"type":"freeform","name":"discount"}]}');
          done();
        });

        test("should fire 'rise-storage-error'", function(done) {
          var responded = false;

          listener = function(response) {
            responded = true;
            tagging.removeEventListener("rise-storage-error", listener);
          };

          tagging.addEventListener("rise-storage-error", listener);
          tagging.go();
          requests[0].respond(404, header, single);

          assert.isTrue(responded);
          done();
        });
      });
    });
  </script>
</body>
</html>
